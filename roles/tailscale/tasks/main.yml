- name: Check if Tailscale is installed
  ansible.builtin.stat:
    path: /usr/sbin/tailscale
  register: tailscale_installed

- name: Download Tailscale install script
  ansible.builtin.get_url:
    url: https://tailscale.com/install.sh
    dest: /tmp/tailscale-install.sh
    mode: '0755'
  when: not tailscale_installed.stat.exists

- name: Run Tailscale install script
  ansible.builtin.command: /tmp/tailscale-install.sh
  when: not tailscale_installed.stat.exists
  changed_when: true
  notify: Restart tailscaled

- name: Ensure tailscaled is enabled and started
  ansible.builtin.systemd:
    name: tailscaled
    enabled: yes
    state: started

- name: Check Tailscale status
  ansible.builtin.command: tailscale status
  register: tailscale_status
  changed_when: false
  failed_when: false
  when: tailscale_installed.stat.exists

- name: Authenticate with Tailscale if logged out and auth key is provided
  ansible.builtin.command: >
    tailscale up --ssh --authkey={{ tailscale_auth_key }} --hostname={{ inventory_hostname }}
  when:
    - tailscale_auth_key is defined
    - tailscale_auth_key | length > 0
    - "'Logged out.' in tailscale_status.stdout"
  changed_when: true

- name: Ensure Tailscale SSH is up (no auth key used or already logged in)
  ansible.builtin.command: >
    tailscale up --ssh --hostname={{ inventory_hostname }}
  when:
    - tailscale_auth_key is not defined or tailscale_auth_key | length == 0
    - "'Logged out.' not in tailscale_status.stdout"
  register: tailscale_up
  changed_when: "'Success.' in tailscale_up.stdout"
  failed_when: tailscale_up.rc != 0 and "'already up'" not in tailscale_up.stdout